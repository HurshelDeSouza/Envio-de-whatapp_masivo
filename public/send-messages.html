<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Mensajes - WhatsApp Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 1.8em;
        }

        .btn-back {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .tabs-container {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e5e7eb;
            color: #333;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .number-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .number-input input {
            flex: 1;
        }

        .number-input span {
            color: #666;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .template-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
        }

        .template-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }

        .template-item:hover {
            background: #f3f4f6;
        }

        .template-item:last-child {
            border-bottom: none;
        }

        .template-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .template-preview {
            color: #666;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: bold;
            display: none;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            display: block;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            display: block;
        }

        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
            display: block;
        }

        .campaign-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .campaign-controls button {
            flex: 1;
        }

        .btn-pause {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-stop {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .options-section {
            border-top: 2px solid #e5e7eb;
            padding-top: 20px;
            margin-top: 20px;
        }

        .options-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì§ Enviar Mensajes Masivos</h1>
            <button class="btn-back" onclick="goBack()">‚Üê Volver al Dashboard</button>
        </div>

        <div class="main-content">
            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tab active" onclick="switchTab('config')">
                    üìù Configurar Mensaje
                </div>
                <div class="tab" onclick="switchTab('templates')">
                    üìã Templates
                </div>
                <div class="tab" onclick="switchTab('campaigns')">
                    üìÖ Campa√±as Programadas
                </div>
                <div class="tab" onclick="switchTab('stats')">
                    üìä Estad√≠sticas
                </div>
            </div>

            <!-- Tab Content: Configurar Mensaje -->
            <div id="tab-config" class="tab-content active">
                <h2>Configurar Mensaje</h2>

                <!-- Radio Buttons para seleccionar modo -->
                <div style="display: flex; gap: 30px; margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 1.1em; font-weight: bold;">
                        <input type="radio" name="send-mode" value="numbers" onchange="changeSendMode('numbers')">
                        üì± Numbers
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 1.1em; font-weight: bold;">
                        <input type="radio" name="send-mode" value="groups" checked onchange="changeSendMode('groups')">
                        üë• Groups
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 1.1em; font-weight: bold;">
                        <input type="radio" name="send-mode" value="contacts" onchange="changeSendMode('contacts')">
                        üìá Contacts
                    </label>
                </div>

                <!-- Secci√≥n para Numbers -->
                <div id="section-numbers" style="display: none;">
                    <div class="form-group">
                        <label>Ingrese n√∫meros para enviar mensajes</label>
                        
                        <!-- Selector de c√≥digo de pa√≠s con bandera -->
                        <div style="display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px;">
                            <!-- Custom Country Selector -->
                            <div style="position: relative; width: 200px;">
                                <div id="country-selector-btn" onclick="toggleCountryDropdown()" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 1em;">
                                    <span id="selected-country">üá®üá¶ +1</span>
                                    <span>‚ñº</span>
                                </div>
                                
                                <!-- Dropdown de pa√≠ses -->
                                <div id="country-dropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; max-width: 350px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 5px; z-index: 1000; max-height: 400px; overflow: hidden;">
                                    <!-- Barra de b√∫squeda -->
                                    <div style="padding: 10px; border-bottom: 1px solid #e5e7eb; background: #f9fafb;">
                                        <input type="text" id="country-search" placeholder="üîç Buscar pa√≠s..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.9em;" oninput="filterCountries()" onclick="event.stopPropagation()">
                                    </div>
                                    
                                    <!-- Lista de pa√≠ses -->
                                    <div id="countries-list" style="max-height: 350px; overflow-y: auto;">
                                        <!-- Los pa√≠ses se cargar√°n aqu√≠ -->
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">
                                    Enter numbers separated by comma or one below the other.<br>
                                    Eg. 5062345678, 5062876543
                                </p>
                                <textarea id="numbers-input" placeholder="Ingrese n√∫meros aqu√≠..." style="width: 100%; min-height: 100px; font-family: monospace; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em;"></textarea>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button class="btn-secondary" onclick="showExampleNumbers()">üìã Ejemplo</button>
                            <button class="btn-secondary" onclick="uploadNumbersFile()">üì§ Subir Excel</button>
                            <select style="padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer;">
                                <option>Campaign Numbers</option>
                            </select>
                        </div>
                    </div>

                    <!-- √Årea de mensaje con opciones de formato -->
                    <div class="form-group">
                        <label>Introducir mensaje</label>
                        <div style="border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                            <!-- Barra de formato -->
                            <div style="background: #f9fafb; padding: 8px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 10px; align-items: center;">
                                <button onclick="formatText('bold')" style="padding: 5px 10px; border: 1px solid #e5e7eb; background: white; border-radius: 4px; cursor: pointer; font-weight: bold;">*text*</button>
                                <button onclick="formatText('italic')" style="padding: 5px 10px; border: 1px solid #e5e7eb; background: white; border-radius: 4px; cursor: pointer; font-style: italic;">_text_</button>
                                <button onclick="formatText('strike')" style="padding: 5px 10px; border: 1px solid #e5e7eb; background: white; border-radius: 4px; cursor: pointer; text-decoration: line-through;">~text~</button>
                                <button onclick="formatText('code')" style="padding: 5px 10px; border: 1px solid #e5e7eb; background: white; border-radius: 4px; cursor: pointer; font-family: monospace;">`text`</button>
                                <span style="color: #999; margin-left: auto;">EMOJIS</span>
                            </div>
                            
                            <!-- √Årea de texto -->
                            <textarea id="message-numbers" placeholder="Escribe tu mensaje aqu√≠..." style="width: 100%; min-height: 150px; border: none; padding: 15px; font-size: 1em; resize: vertical; font-family: inherit;"></textarea>
                            
                            <!-- Barra inferior con clip y template -->
                            <div style="background: #f9fafb; padding: 10px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; align-items: center;">
                                <button onclick="attachFile()" style="padding: 8px 15px; border: 1px solid #e5e7eb; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                    üìé
                                </button>
                                
                                <div style="position: relative;">
                                    <button onclick="toggleTemplateMenu()" id="template-btn" style="padding: 8px 15px; border: 1px solid #e5e7eb; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                        Template ‚ñº
                                    </button>
                                    
                                    <!-- Men√∫ desplegable de templates -->
                                    <div id="template-dropdown" style="display: none; position: absolute; bottom: 100%; left: 0; background: white; border: 2px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; margin-bottom: 5px; z-index: 1000;">
                                        <div style="padding: 10px; color: #666; text-align: center; border-bottom: 1px solid #e5e7eb;">
                                            ¬°Nada que mostrar!
                                        </div>
                                        <div onclick="showAddTemplateModal()" style="padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #10b981; font-weight: bold; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                            üìã Add Template
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal: Add Template -->
                <div id="add-template-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
                    <div style="background: #e0f2f1; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; position: relative;">
                        <button onclick="closeAddTemplateModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 2em; cursor: pointer; color: #333;">√ó</button>
                        
                        <h2 style="margin-bottom: 20px; color: #333;">Add Template</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <textarea id="template-content" placeholder="Escribe tu plantilla aqu√≠..." style="width: 100%; min-height: 200px; padding: 15px; border: 2px solid #b2dfdb; border-radius: 8px; font-size: 1em; resize: vertical; font-family: inherit;"></textarea>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <label style="color: #333; font-weight: bold;">Save as</label>
                            <input type="text" id="template-name" placeholder="Nombre de la plantilla" style="flex: 1; padding: 12px; border: 2px solid #b2dfdb; border-radius: 8px; font-size: 1em;">
                        </div>
                        
                        <button onclick="saveTemplate()" style="background: #26a69a; color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; width: 100%;">
                            Save Template
                        </button>
                    </div>
                </div>

                <!-- Secci√≥n para Groups -->
                <div id="section-groups">
                    <div class="form-group">
                        <label>Filtrar por Pa√≠s</label>
                        <select id="country-select" onchange="loadGroups()">
                            <option value="USA">üá∫üá∏ USA</option>
                            <option value="COLOMBIA">üá®üá¥ Colombia</option>
                            <option value="VENEZUELA">üáªüá™ Venezuela</option>
                            <option value="ARGENTINA">üá¶üá∑ Argentina</option>
                            <option value="MEXICO">üá≤üáΩ M√©xico</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                            Seleccionar Todos (<span id="group-count">0</span> grupos)
                        </label>
                        <div style="margin-bottom: 10px;">
                            <input type="text" id="search-groups" placeholder="üîç Buscar grupos por nombre..." style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="filterGroups()">
                        </div>
                        <div id="groups-list" style="max-height: 200px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 8px; padding: 10px;">
                            <p style="color: #666;">Cargando grupos...</p>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n para Contacts -->
                <div id="section-contacts" style="display: none;">
                    <div class="form-group">
                        <label>Seleccionar contactos para enviar mensaje</label>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">
                            Seleccione contactos desde el dropdown...
                        </p>
                        <select id="contacts-select" multiple style="min-height: 150px;">
                            <option value="">Cargando contactos...</option>
                        </select>
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="text" id="search-contacts" placeholder="üîç Buscar contactos por nombre..." style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="filterContacts()">
                    </div>
                    <div style="margin-top: 10px;">
                        <label>
                            <input type="checkbox" id="select-all-contacts" onchange="toggleSelectAllContacts()">
                            Seleccionar Todos
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Mensaje</label>
                    <textarea id="message" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                </div>

                <div class="options-section">
                    <h3>‚öôÔ∏è Opciones Avanzadas</h3>

                    <div class="checkbox-group">
                        <input type="checkbox" id="enable-delays" checked>
                        <label for="enable-delays">Agregar intervalos de tiempo entre mensajes</label>
                    </div>

                    <div class="form-group">
                        <label>Delay entre mensajes (segundos)</label>
                        <div class="number-input">
                            <input type="number" id="delay-min" value="5" min="1" max="60">
                            <span>a</span>
                            <input type="number" id="delay-max" value="15" min="1" max="60">
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="enable-batches" checked>
                        <label for="enable-batches">Agregar lotes (Recomendado)</label>
                    </div>

                    <div class="form-group">
                        <label>Tama√±o de lote</label>
                        <input type="number" id="batch-size" value="50" min="10" max="200">
                    </div>

                    <div class="form-group">
                        <label>Pausa entre lotes (minutos)</label>
                        <input type="number" id="batch-delay" value="30" min="5" max="120">
                    </div>

                    <div class="form-group">
                        <label>Pausa cada X mensajes</label>
                        <input type="number" id="pause-every" value="50" min="10" max="100">
                    </div>

                    <div class="form-group">
                        <label>Duraci√≥n de pausa (minutos)</label>
                        <input type="number" id="pause-duration" value="10" min="5" max="60">
                    </div>
                </div>

                <button class="btn-primary" onclick="sendCampaign()">
                    üì§ Enviar Mensajes
                </button>

                <div class="campaign-controls" id="campaign-controls" style="display: none;">
                    <button class="btn-primary btn-pause" onclick="pauseCampaign()">‚è∏Ô∏è Pausar</button>
                    <button class="btn-primary btn-stop" onclick="stopCampaign()">üõë Detener</button>
                </div>

                <div id="status-message" class="status-message"></div>
            </div>

            <!-- Tab Content: Templates -->
            <div id="tab-templates" class="tab-content">
                <h2>üìã Templates de Mensajes</h2>
                <p style="color: #666; margin-bottom: 20px;">Guarda y reutiliza tus mensajes m√°s frecuentes</p>
                
                <button class="btn-secondary" onclick="showNewTemplateModal()" style="margin-bottom: 20px;">
                    ‚ûï Nuevo Template
                </button>

                <div class="template-list" id="templates-list" style="max-height: 500px;">
                    <p style="color: #666;">Cargando templates...</p>
                </div>
            </div>

            <!-- Tab Content: Campa√±as Programadas -->
            <div id="tab-campaigns" class="tab-content">
                <h2>üìÖ Campa√±as Programadas</h2>
                <p style="color: #666; margin-bottom: 20px;">Programa tus env√≠os para fecha y hora espec√≠fica</p>

                <div style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="showScheduleCampaignModal()">
                        ‚ûï Programar Nueva Campa√±a
                    </button>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Pr√≥ximas Campa√±as</h3>
                <div id="scheduled-campaigns-list" style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; min-height: 200px;">
                    <p style="color: #666;">No hay campa√±as programadas</p>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Campa√±as Pausadas</h3>
                <div id="paused-campaigns-list" style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; min-height: 200px;">
                    <p style="color: #666;">No hay campa√±as pausadas</p>
                </div>
            </div>

            <!-- Tab Content: Estad√≠sticas -->
            <div id="tab-stats" class="tab-content">
                <h2>üìä Estad√≠sticas de Env√≠os</h2>
                <p style="color: #666; margin-bottom: 20px;">Monitorea el rendimiento de tus campa√±as</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;" id="stat-total">0</div>
                        <div style="font-size: 1.1em;">Total Grupos</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;" id="stat-sent">0</div>
                        <div style="font-size: 1.1em;">Enviados</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;" id="stat-failed">0</div>
                        <div style="font-size: 1.1em;">Fallidos</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;" id="stat-progress">0%</div>
                        <div style="font-size: 1.1em;">Progreso</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px;">Historial de Campa√±as</h3>
                <div id="campaigns-history" style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; min-height: 300px;">
                    <p style="color: #666;">No hay historial de campa√±as</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let selectedGroups = [];
        let allGroups = [];
        let phone = '';
        let campaignRunning = false;

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            phone = urlParams.get('phone');
            
            if (!phone) {
                alert('N√∫mero de tel√©fono no especificado');
                window.location.href = '/';
                return;
            }

            loadGroups();
            loadTemplates();
            loadScheduledCampaigns();
            setupSocketListeners();
        };

        function switchTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar el tab seleccionado
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');

            // Cargar datos seg√∫n el tab
            if (tabName === 'templates') {
                loadTemplates();
            } else if (tabName === 'campaigns') {
                loadScheduledCampaigns();
            } else if (tabName === 'stats') {
                loadStatistics();
            }
        }

        function changeSendMode(mode) {
            // Ocultar todas las secciones
            document.getElementById('section-numbers').style.display = 'none';
            document.getElementById('section-groups').style.display = 'none';
            document.getElementById('section-contacts').style.display = 'none';

            // Mostrar la secci√≥n seleccionada
            document.getElementById('section-' + mode).style.display = 'block';

            // Cargar datos seg√∫n el modo
            if (mode === 'groups') {
                loadGroups();
            } else if (mode === 'contacts') {
                loadContacts();
            }
        }

        function filterGroups() {
            const searchTerm = document.getElementById('search-groups').value.toLowerCase();
            const filteredGroups = allGroups.filter(group => 
                (group.name || '').toLowerCase().includes(searchTerm)
            );
            displayGroups(filteredGroups);
        }

        function showExampleNumbers() {
            document.getElementById('numbers-input').value = '+15062345678, +15062876543\n+15063456789';
        }

        function uploadNumbersFile() {
            alert('Funcionalidad de subir Excel en desarrollo');
        }

        function formatText(type) {
            const textarea = document.getElementById('message-numbers');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (!selectedText) {
                alert('Por favor selecciona el texto que deseas formatear');
                return;
            }
            
            let formattedText = '';
            switch(type) {
                case 'bold':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'italic':
                    formattedText = `_${selectedText}_`;
                    break;
                case 'strike':
                    formattedText = `~${selectedText}~`;
                    break;
                case 'code':
                    formattedText = `\`${selectedText}\``;
                    break;
            }
            
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start, start + formattedText.length);
        }

        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,application/pdf,.doc,.docx';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    alert(`Archivo seleccionado: ${file.name}\n(Funcionalidad de env√≠o en desarrollo)`);
                }
            };
            input.click();
        }

        function toggleTemplateMenu() {
            const dropdown = document.getElementById('template-dropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Cerrar el men√∫ si se hace clic fuera de √©l
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('template-dropdown');
            const btn = document.getElementById('template-btn');
            
            if (dropdown && btn && !dropdown.contains(event.target) && !btn.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        function showAddTemplateModal() {
            document.getElementById('add-template-modal').style.display = 'flex';
            document.getElementById('template-dropdown').style.display = 'none';
        }

        function closeAddTemplateModal() {
            document.getElementById('add-template-modal').style.display = 'none';
            document.getElementById('template-content').value = '';
            document.getElementById('template-name').value = '';
        }

        function saveTemplate() {
            const content = document.getElementById('template-content').value.trim();
            const name = document.getElementById('template-name').value.trim();
            
            if (!content) {
                alert('Por favor escribe el contenido de la plantilla');
                return;
            }
            
            if (!name) {
                alert('Por favor escribe un nombre para la plantilla');
                return;
            }
            
            fetch('/api/templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name: name, 
                    message: content, 
                    category: 'general' 
                })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    alert('‚úÖ Template guardado exitosamente');
                    closeAddTemplateModal();
                    loadTemplates();
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            })
            .catch(error => {
                alert('‚ùå Error al guardar template: ' + error.message);
            });
        }

        // Lista completa de pa√≠ses con c√≥digos
        const countries = [
            { name: 'Canada', code: '+1', flag: 'üá®üá¶', native: 'Canada' },
            { name: 'United States', code: '+1', flag: 'üá∫üá∏', native: 'United States' },
            { name: 'Afghanistan', code: '+93', flag: 'üá¶üá´', native: 'ÿßŸÅÿ∫ÿßŸÜÿ≥ÿ™ÿßŸÜ' },
            { name: 'Albania', code: '+355', flag: 'üá¶üá±', native: 'Shqip√´ri' },
            { name: 'Algeria', code: '+213', flag: 'üá©üáø', native: 'ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±' },
            { name: 'American Samoa', code: '+1', flag: 'üá¶üá∏', native: 'American Samoa' },
            { name: 'Andorra', code: '+376', flag: 'üá¶üá©', native: 'Andorra' },
            { name: 'Angola', code: '+244', flag: 'üá¶üá¥', native: 'Angola' },
            { name: 'Argentina', code: '+54', flag: 'üá¶üá∑', native: 'Argentina' },
            { name: 'Armenia', code: '+374', flag: 'üá¶üá≤', native: '’Ä’°’µ’°’Ω’ø’°’∂' },
            { name: 'Australia', code: '+61', flag: 'üá¶üá∫', native: 'Australia' },
            { name: 'Austria', code: '+43', flag: 'üá¶üáπ', native: '√ñsterreich' },
            { name: 'Azerbaijan', code: '+994', flag: 'üá¶üáø', native: 'Az…ôrbaycan' },
            { name: 'Bahamas', code: '+1242', flag: 'üáßüá∏', native: 'Bahamas' },
            { name: 'Bahrain', code: '+973', flag: 'üáßüá≠', native: 'ÿßŸÑÿ®ÿ≠ÿ±ŸäŸÜ' },
            { name: 'Bangladesh', code: '+880', flag: 'üáßüá©', native: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂' },
            { name: 'Barbados', code: '+1246', flag: 'üáßüáß', native: 'Barbados' },
            { name: 'Belarus', code: '+375', flag: 'üáßüáæ', native: '–ë–µ–ª–∞—Ä—É—Å—å' },
            { name: 'Belgium', code: '+32', flag: 'üáßüá™', native: 'Belgi√´' },
            { name: 'Belize', code: '+501', flag: 'üáßüáø', native: 'Belize' },
            { name: 'Benin', code: '+229', flag: 'üáßüáØ', native: 'B√©nin' },
            { name: 'Bolivia', code: '+591', flag: 'üáßüá¥', native: 'Bolivia' },
            { name: 'Bosnia', code: '+387', flag: 'üáßüá¶', native: 'Bosna i Hercegovina' },
            { name: 'Botswana', code: '+267', flag: 'üáßüáº', native: 'Botswana' },
            { name: 'Brazil', code: '+55', flag: 'üáßüá∑', native: 'Brasil' },
            { name: 'Bulgaria', code: '+359', flag: 'üáßüá¨', native: '–ë—ä–ª–≥–∞—Ä–∏—è' },
            { name: 'Cambodia', code: '+855', flag: 'üá∞üá≠', native: '·ûÄ·ûò·üí·ûñ·ûª·ûá·û∂' },
            { name: 'Cameroon', code: '+237', flag: 'üá®üá≤', native: 'Cameroun' },
            { name: 'Chile', code: '+56', flag: 'üá®üá±', native: 'Chile' },
            { name: 'China', code: '+86', flag: 'üá®üá≥', native: '‰∏≠ÂõΩ' },
            { name: 'Colombia', code: '+57', flag: 'üá®üá¥', native: 'Colombia' },
            { name: 'Costa Rica', code: '+506', flag: 'üá®üá∑', native: 'Costa Rica' },
            { name: 'Croatia', code: '+385', flag: 'üá≠üá∑', native: 'Hrvatska' },
            { name: 'Cuba', code: '+53', flag: 'üá®üá∫', native: 'Cuba' },
            { name: 'Cyprus', code: '+357', flag: 'üá®üáæ', native: 'ŒöœçœÄœÅŒøœÇ' },
            { name: 'Czech Republic', code: '+420', flag: 'üá®üáø', native: 'ƒåesk√° republika' },
            { name: 'Denmark', code: '+45', flag: 'üá©üá∞', native: 'Danmark' },
            { name: 'Dominican Republic', code: '+1809', flag: 'üá©üá¥', native: 'Rep√∫blica Dominicana' },
            { name: 'Ecuador', code: '+593', flag: 'üá™üá®', native: 'Ecuador' },
            { name: 'Egypt', code: '+20', flag: 'üá™üá¨', native: 'ŸÖÿµÿ±' },
            { name: 'El Salvador', code: '+503', flag: 'üá∏üáª', native: 'El Salvador' },
            { name: 'Estonia', code: '+372', flag: 'üá™üá™', native: 'Eesti' },
            { name: 'Ethiopia', code: '+251', flag: 'üá™üáπ', native: '·ä¢·âµ·ãÆ·åµ·ã´' },
            { name: 'Finland', code: '+358', flag: 'üá´üáÆ', native: 'Suomi' },
            { name: 'France', code: '+33', flag: 'üá´üá∑', native: 'France' },
            { name: 'Germany', code: '+49', flag: 'üá©üá™', native: 'Deutschland' },
            { name: 'Ghana', code: '+233', flag: 'üá¨üá≠', native: 'Ghana' },
            { name: 'Greece', code: '+30', flag: 'üá¨üá∑', native: 'ŒïŒªŒªŒ¨Œ¥Œ±' },
            { name: 'Guatemala', code: '+502', flag: 'üá¨üáπ', native: 'Guatemala' },
            { name: 'Haiti', code: '+509', flag: 'üá≠üáπ', native: 'Ha√Øti' },
            { name: 'Honduras', code: '+504', flag: 'üá≠üá≥', native: 'Honduras' },
            { name: 'Hong Kong', code: '+852', flag: 'üá≠üá∞', native: 'È¶ôÊ∏Ø' },
            { name: 'Hungary', code: '+36', flag: 'üá≠üá∫', native: 'Magyarorsz√°g' },
            { name: 'Iceland', code: '+354', flag: 'üáÆüá∏', native: '√çsland' },
            { name: 'India', code: '+91', flag: 'üáÆüá≥', native: '‡§≠‡§æ‡§∞‡§§' },
            { name: 'Indonesia', code: '+62', flag: 'üáÆüá©', native: 'Indonesia' },
            { name: 'Iran', code: '+98', flag: 'üáÆüá∑', native: 'ÿß€åÿ±ÿßŸÜ' },
            { name: 'Iraq', code: '+964', flag: 'üáÆüá∂', native: 'ÿßŸÑÿπÿ±ÿßŸÇ' },
            { name: 'Ireland', code: '+353', flag: 'üáÆüá™', native: '√âire' },
            { name: 'Israel', code: '+972', flag: 'üáÆüá±', native: '◊ô◊©◊®◊ê◊ú' },
            { name: 'Italy', code: '+39', flag: 'üáÆüáπ', native: 'Italia' },
            { name: 'Jamaica', code: '+1876', flag: 'üáØüá≤', native: 'Jamaica' },
            { name: 'Japan', code: '+81', flag: 'üáØüáµ', native: 'Êó•Êú¨' },
            { name: 'Jordan', code: '+962', flag: 'üáØüá¥', native: 'ÿßŸÑÿ£ÿ±ÿØŸÜ' },
            { name: 'Kazakhstan', code: '+7', flag: 'üá∞üáø', native: '“ö–∞–∑–∞“õ—Å—Ç–∞–Ω' },
            { name: 'Kenya', code: '+254', flag: 'üá∞üá™', native: 'Kenya' },
            { name: 'Kuwait', code: '+965', flag: 'üá∞üáº', native: 'ÿßŸÑŸÉŸàŸäÿ™' },
            { name: 'Latvia', code: '+371', flag: 'üá±üáª', native: 'Latvija' },
            { name: 'Lebanon', code: '+961', flag: 'üá±üáß', native: 'ŸÑÿ®ŸÜÿßŸÜ' },
            { name: 'Libya', code: '+218', flag: 'üá±üáæ', native: 'ŸÑŸäÿ®Ÿäÿß' },
            { name: 'Lithuania', code: '+370', flag: 'üá±üáπ', native: 'Lietuva' },
            { name: 'Luxembourg', code: '+352', flag: 'üá±üá∫', native: 'Luxembourg' },
            { name: 'Malaysia', code: '+60', flag: 'üá≤üáæ', native: 'Malaysia' },
            { name: 'Mexico', code: '+52', flag: 'üá≤üáΩ', native: 'M√©xico' },
            { name: 'Morocco', code: '+212', flag: 'üá≤üá¶', native: 'ÿßŸÑŸÖÿ∫ÿ±ÿ®' },
            { name: 'Netherlands', code: '+31', flag: 'üá≥üá±', native: 'Nederland' },
            { name: 'New Zealand', code: '+64', flag: 'üá≥üáø', native: 'New Zealand' },
            { name: 'Nicaragua', code: '+505', flag: 'üá≥üáÆ', native: 'Nicaragua' },
            { name: 'Nigeria', code: '+234', flag: 'üá≥üá¨', native: 'Nigeria' },
            { name: 'Norway', code: '+47', flag: 'üá≥üá¥', native: 'Norge' },
            { name: 'Pakistan', code: '+92', flag: 'üáµüá∞', native: 'Ÿæÿß⁄©ÿ≥ÿ™ÿßŸÜ' },
            { name: 'Panama', code: '+507', flag: 'üáµüá¶', native: 'Panam√°' },
            { name: 'Paraguay', code: '+595', flag: 'üáµüáæ', native: 'Paraguay' },
            { name: 'Peru', code: '+51', flag: 'üáµüá™', native: 'Per√∫' },
            { name: 'Philippines', code: '+63', flag: 'üáµüá≠', native: 'Philippines' },
            { name: 'Poland', code: '+48', flag: 'üáµüá±', native: 'Polska' },
            { name: 'Portugal', code: '+351', flag: 'üáµüáπ', native: 'Portugal' },
            { name: 'Puerto Rico', code: '+1787', flag: 'üáµüá∑', native: 'Puerto Rico' },
            { name: 'Qatar', code: '+974', flag: 'üá∂üá¶', native: 'ŸÇÿ∑ÿ±' },
            { name: 'Romania', code: '+40', flag: 'üá∑üá¥', native: 'Rom√¢nia' },
            { name: 'Russia', code: '+7', flag: 'üá∑üá∫', native: '–†–æ—Å—Å–∏—è' },
            { name: 'Saudi Arabia', code: '+966', flag: 'üá∏üá¶', native: 'ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©' },
            { name: 'Serbia', code: '+381', flag: 'üá∑üá∏', native: '–°—Ä–±–∏—ò–∞' },
            { name: 'Singapore', code: '+65', flag: 'üá∏üá¨', native: 'Singapore' },
            { name: 'Slovakia', code: '+421', flag: 'üá∏üá∞', native: 'Slovensko' },
            { name: 'Slovenia', code: '+386', flag: 'üá∏üáÆ', native: 'Slovenija' },
            { name: 'South Africa', code: '+27', flag: 'üáøüá¶', native: 'South Africa' },
            { name: 'South Korea', code: '+82', flag: 'üá∞üá∑', native: 'ÎåÄÌïúÎØºÍµ≠' },
            { name: 'Spain', code: '+34', flag: 'üá™üá∏', native: 'Espa√±a' },
            { name: 'Sri Lanka', code: '+94', flag: 'üá±üá∞', native: '‡∑Å‡∑ä‚Äç‡∂ª‡∑ì ‡∂Ω‡∂Ç‡∂ö‡∑è' },
            { name: 'Sweden', code: '+46', flag: 'üá∏üá™', native: 'Sverige' },
            { name: 'Switzerland', code: '+41', flag: 'üá®üá≠', native: 'Schweiz' },
            { name: 'Syria', code: '+963', flag: 'üá∏üáæ', native: 'ÿ≥Ÿàÿ±Ÿäÿß' },
            { name: 'Taiwan', code: '+886', flag: 'üáπüáº', native: 'Âè∞ÁÅ£' },
            { name: 'Thailand', code: '+66', flag: 'üáπüá≠', native: '‡πÑ‡∏ó‡∏¢' },
            { name: 'Tunisia', code: '+216', flag: 'üáπüá≥', native: 'ÿ™ŸàŸÜÿ≥' },
            { name: 'Turkey', code: '+90', flag: 'üáπüá∑', native: 'T√ºrkiye' },
            { name: 'Ukraine', code: '+380', flag: 'üá∫üá¶', native: '–£–∫—Ä–∞—ó–Ω–∞' },
            { name: 'United Arab Emirates', code: '+971', flag: 'üá¶üá™', native: 'ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™' },
            { name: 'United Kingdom', code: '+44', flag: 'üá¨üáß', native: 'United Kingdom' },
            { name: 'Uruguay', code: '+598', flag: 'üá∫üáæ', native: 'Uruguay' },
            { name: 'Venezuela', code: '+58', flag: 'üáªüá™', native: 'Venezuela' },
            { name: 'Vietnam', code: '+84', flag: 'üáªüá≥', native: 'Vi·ªát Nam' },
            { name: 'Yemen', code: '+967', flag: 'üáæüá™', native: 'ÿßŸÑŸäŸÖŸÜ' }
        ];

        let allCountries = countries;
        let selectedCountryCode = '+1';

        // Inicializar lista de pa√≠ses
        function initCountriesList() {
            displayCountries(allCountries);
        }

        function displayCountries(countriesToShow) {
            const container = document.getElementById('countries-list');
            
            container.innerHTML = countriesToShow.map(country => `
                <div onclick="selectCountry('${country.code}', '${country.flag}', '${country.name}')" style="padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f3f4f6; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                    <span style="font-size: 1.5em;">${country.flag}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: #333;">${country.name}</div>
                        <div style="font-size: 0.85em; color: #666;">${country.native}</div>
                    </div>
                    <span style="color: #666; font-weight: bold;">${country.code}</span>
                </div>
            `).join('');
        }

        function toggleCountryDropdown() {
            const dropdown = document.getElementById('country-dropdown');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                document.getElementById('country-search').value = '';
                displayCountries(allCountries);
            }
        }

        function selectCountry(code, flag, name) {
            selectedCountryCode = code;
            document.getElementById('selected-country').textContent = `${flag} ${code}`;
            document.getElementById('country-dropdown').style.display = 'none';
        }

        function filterCountries() {
            const searchTerm = document.getElementById('country-search').value.toLowerCase();
            const filtered = allCountries.filter(country => 
                country.name.toLowerCase().includes(searchTerm) ||
                country.native.toLowerCase().includes(searchTerm) ||
                country.code.includes(searchTerm)
            );
            displayCountries(filtered);
        }

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('country-dropdown');
            const btn = document.getElementById('country-selector-btn');
            
            if (dropdown && btn && !dropdown.contains(event.target) && !btn.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Inicializar cuando cargue la p√°gina
        window.addEventListener('load', function() {
            initCountriesList();
        });

        async function loadContacts() {
            // Simular carga de contactos
            const contactsSelect = document.getElementById('contacts-select');
            contactsSelect.innerHTML = `
                <option value="contact1">Juan P√©rez - +1234567890</option>
                <option value="contact2">Mar√≠a Garc√≠a - +0987654321</option>
                <option value="contact3">Carlos L√≥pez - +1122334455</option>
            `;
        }

        function filterContacts() {
            const searchTerm = document.getElementById('search-contacts').value.toLowerCase();
            const options = document.querySelectorAll('#contacts-select option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function toggleSelectAllContacts() {
            const selectAll = document.getElementById('select-all-contacts').checked;
            const options = document.querySelectorAll('#contacts-select option');
            
            options.forEach(option => {
                option.selected = selectAll;
            });
        }

        function setupSocketListeners() {
            socket.on('campaign-completed', (data) => {
                if (data.phone === phone) {
                    showStatus('success', `‚úÖ Campa√±a completada! Enviados: ${data.results.sent}, Fallidos: ${data.results.failed}`);
                    campaignRunning = false;
                    document.getElementById('campaign-controls').style.display = 'none';
                }
            });

            socket.on('campaign-error', (data) => {
                if (data.phone === phone) {
                    showStatus('error', `‚ùå Error en campa√±a: ${data.error}`);
                    campaignRunning = false;
                    document.getElementById('campaign-controls').style.display = 'none';
                }
            });
        }

        async function loadGroups() {
            const country = document.getElementById('country-select').value;
            
            try {
                const response = await fetch(`/api/groups/successful?country=${country}`);
                const groups = await response.json();
                
                allGroups = groups;
                displayGroups(groups);
            } catch (error) {
                console.error('Error cargando grupos:', error);
            }
        }

        function displayGroups(groups) {
            const container = document.getElementById('groups-list');
            document.getElementById('group-count').textContent = groups.length;
            
            if (groups.length === 0) {
                container.innerHTML = '<p style="color: #666;">No hay grupos disponibles</p>';
                return;
            }

            container.innerHTML = groups.map(group => `
                <div style="padding: 8px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between;">
                    <label style="flex: 1; cursor: pointer; text-align: left;" onclick="event.target.nextElementSibling.click()">
                        ${group.name || 'Grupo sin nombre'}
                    </label>
                    <input type="checkbox" class="group-checkbox" value="${group.group_id}" onchange="updateSelectedGroups()" style="margin: 0;">
                </div>
            `).join('');
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all').checked;
            const checkboxes = document.querySelectorAll('.group-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
            });
            
            updateSelectedGroups();
        }

        function updateSelectedGroups() {
            const checkboxes = document.querySelectorAll('.group-checkbox:checked');
            selectedGroups = Array.from(checkboxes).map(cb => cb.value);
            console.log('Grupos seleccionados:', selectedGroups.length);
        }

        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                const data = await response.json();
                
                if (data.success) {
                    displayTemplates(data.templates);
                }
            } catch (error) {
                console.error('Error cargando templates:', error);
            }
        }

        function displayTemplates(templates) {
            const container = document.getElementById('templates-list');
            
            if (templates.length === 0) {
                container.innerHTML = '<p style="color: #666;">No hay templates</p>';
                return;
            }

            container.innerHTML = templates.map(template => `
                <div class="template-item" onclick="useTemplate(${template.id})">
                    <div class="template-name">${template.name}</div>
                    <div class="template-preview">${template.message}</div>
                </div>
            `).join('');
        }

        function useTemplate(templateId) {
            fetch(`/api/templates`)
                .then(res => res.json())
                .then(data => {
                    const template = data.templates.find(t => t.id === templateId);
                    if (template) {
                        document.getElementById('message').value = template.message;
                    }
                });
        }

        async function sendCampaign() {
            if (selectedGroups.length === 0) {
                showStatus('error', 'Por favor selecciona al menos un grupo');
                return;
            }

            const message = document.getElementById('message').value.trim();
            if (!message) {
                showStatus('error', 'Por favor escribe un mensaje');
                return;
            }

            const config = {
                delays: {
                    min: parseInt(document.getElementById('delay-min').value),
                    max: parseInt(document.getElementById('delay-max').value)
                },
                batchSize: parseInt(document.getElementById('batch-size').value),
                batchDelay: parseInt(document.getElementById('batch-delay').value),
                pauseEvery: parseInt(document.getElementById('pause-every').value),
                pauseDuration: parseInt(document.getElementById('pause-duration').value)
            };

            try {
                showStatus('info', 'üöÄ Iniciando campa√±a...');
                campaignRunning = true;
                document.getElementById('campaign-controls').style.display = 'flex';

                const response = await fetch('/api/campaigns/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone,
                        groupIds: selectedGroups,
                        message,
                        config
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('info', 'üì§ Campa√±a en progreso...');
                } else {
                    showStatus('error', result.message);
                    campaignRunning = false;
                    document.getElementById('campaign-controls').style.display = 'none';
                }
            } catch (error) {
                showStatus('error', 'Error: ' + error.message);
                campaignRunning = false;
                document.getElementById('campaign-controls').style.display = 'none';
            }
        }

        function pauseCampaign() {
            showStatus('info', '‚è∏Ô∏è Pausando campa√±a...');
            // Implementar l√≥gica de pausa
        }

        function stopCampaign() {
            if (confirm('¬øEst√°s seguro de que quieres detener la campa√±a?')) {
                showStatus('info', 'üõë Deteniendo campa√±a...');
                campaignRunning = false;
                document.getElementById('campaign-controls').style.display = 'none';
            }
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = 'status-message ' + type;
            statusDiv.textContent = message;
        }

        function goBack() {
            window.location.href = `/dashboard?phone=${encodeURIComponent(phone)}`;
        }

        function showNewTemplateModal() {
            const name = prompt('Nombre del template:');
            if (!name) return;

            const message = prompt('Mensaje del template:');
            if (!message) return;

            const category = prompt('Categor√≠a (opcional):', 'general');

            fetch('/api/templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, message, category: category || 'general' })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    alert('Template creado exitosamente');
                    loadTemplates();
                } else {
                    alert('Error: ' + result.error);
                }
            });
        }

        async function loadScheduledCampaigns() {
            try {
                const response = await fetch(`/api/campaigns/scheduled?phone=${phone}`);
                const data = await response.json();
                
                if (data.success && data.campaigns.length > 0) {
                    displayScheduledCampaigns(data.campaigns);
                }

                const pausedResponse = await fetch(`/api/campaigns/paused?phone=${phone}`);
                const pausedData = await pausedResponse.json();
                
                if (pausedData.success && pausedData.campaigns.length > 0) {
                    displayPausedCampaigns(pausedData.campaigns);
                }
            } catch (error) {
                console.error('Error cargando campa√±as:', error);
            }
        }

        function displayScheduledCampaigns(campaigns) {
            const container = document.getElementById('scheduled-campaigns-list');
            container.innerHTML = campaigns.map(campaign => `
                <div style="padding: 15px; border-bottom: 1px solid #e5e7eb; background: #f9fafb; margin-bottom: 10px; border-radius: 8px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">${campaign.name}</div>
                    <div style="color: #666; font-size: 0.9em;">
                        üìÖ ${new Date(campaign.scheduled_at).toLocaleString()}
                    </div>
                    <div style="color: #666; font-size: 0.9em;">
                        üìä ${JSON.parse(campaign.group_ids).length} grupos
                    </div>
                    <button onclick="deleteCampaign(${campaign.id})" style="margin-top: 10px; padding: 5px 15px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üóëÔ∏è Eliminar
                    </button>
                </div>
            `).join('');
        }

        function displayPausedCampaigns(campaigns) {
            const container = document.getElementById('paused-campaigns-list');
            container.innerHTML = campaigns.map(campaign => `
                <div style="padding: 15px; border-bottom: 1px solid #e5e7eb; background: #fef3c7; margin-bottom: 10px; border-radius: 8px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">${campaign.name}</div>
                    <div style="color: #666; font-size: 0.9em;">
                        üìä ${JSON.parse(campaign.group_ids).length} grupos
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="resumeCampaign(${campaign.id})" style="padding: 5px 15px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ‚ñ∂Ô∏è Reanudar
                        </button>
                        <button onclick="deleteCampaign(${campaign.id})" style="padding: 5px 15px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showScheduleCampaignModal() {
            alert('Funcionalidad de programaci√≥n en desarrollo');
        }

        async function deleteCampaign(id) {
            if (!confirm('¬øEliminar esta campa√±a?')) return;

            try {
                const response = await fetch(`/api/campaigns/${id}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    alert('Campa√±a eliminada');
                    loadScheduledCampaigns();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function resumeCampaign(id) {
            try {
                const response = await fetch(`/api/campaigns/${id}/resume`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert('Campa√±a reanudada');
                    loadScheduledCampaigns();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function loadStatistics() {
            // Cargar estad√≠sticas desde el servidor
            console.log('Cargando estad√≠sticas...');
        }
    </script>
</body>
</html>
